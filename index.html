<body>
<h1>Volunteer Service Hours</h1>
<button onclick="login()">Login with Google</button>
<button onclick="logout()">Logout</button>

<div id="log-container" style="display: none;">
    <h2>Log Service Hours</h2>

    <label>Select Organization:
        <select id="org-select">
            <option value="">-- Add new organization --</option>
        </select>
    </label><br/>

    <div id="new-org-fields">
        <label>Organization Name: <input type="text" id="org-name" required /></label><br/>
        <label>Address: <input type="text" id="org-address" /></label><br/>
        <label>Contact First Name: <input type="text" id="contact-first" /></label><br/>
        <label>Contact Last Name: <input type="text" id="contact-last" /></label><br/>
        <label>Title: <input type="text" id="contact-title" /></label><br/>
        <label>Email: <input type="email" id="contact-email" /></label><br/>
        <label>Phone: <input type="tel" id="contact-phone" /></label><br/>
    </div>

    <form id="log-form">
        <label>Date: <input type="date" id="log-date" required /></label><br/>
        <label>Hours: <input type="number" id="log-hours" min="1" required /></label><br/>
        <label>Organization Name: <input type="text" id="org-name" required /></label><br/>
        <label>Address: <input type="text" id="org-address" required /></label><br/>
        <label>Contact First Name: <input type="text" id="contact-first" /></label><br/>
        <label>Contact Last Name: <input type="text" id="contact-last" /></label><br/>
        <label>Title: <input type="text" id="contact-title" /></label><br/>
        <label>Email: <input type="email" id="contact-email" /></label><br/>
        <label>Phone: <input type="tel" id="contact-phone" /></label><br/>
        <button type="submit">Submit</button>
    </form>
</div>

<p id="user-info"></p>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyA4vFPt7AllttEVTccPqx2mUkq3djDAX_M",
        authDomain: "hoby-ny-east-service-hours.firebaseapp.com",
        projectId: "hoby-ny-east-service-hours",
        storageBucket: "hoby-ny-east-service-hours.firebasestorage.app",
        messagingSenderId: "570357288484",
        appId: "1:570357288484:web:ffd7fc0cd0a880db46d2b1",
        measurementId: "G-J5BP1KY64B"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    window.login = () => {
        const provider = new GoogleAuthProvider();
        signInWithPopup(auth, provider)
            .then((result) => {
                document.getElementById("user-info").textContent = `Hello, ${result.user.displayName}`;
                console.log("Signed in:", result.user);
            })
            .catch((error) => console.error("Login error:", error));
    };

    window.logout = () => {
        signOut(auth)
            .then(() => {
                document.getElementById("user-info").textContent = "";
                console.log("Logged out");
            })
            .catch((error) => console.error("Logout error:", error));
    };

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            document.getElementById("user-info").textContent = `Welcome, ${user.displayName}`;
            document.getElementById("log-container").style.display = "block";
        } else {
            document.getElementById("user-info").textContent = "";
            document.getElementById("log-container").style.display = "none";
        }

        const orgSelect = document.getElementById("org-select");
        const orgRef = collection(db, "organizations");
        const snapshot = await getDocs(orgRef);

        snapshot.forEach(doc => {
            const option = document.createElement("option");
            option.value = doc.id;
            option.textContent = doc.data().name;
            orgSelect.appendChild(option);
        });

    });

    import { getFirestore, collection, addDoc, doc, setDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore.js";

    const db = getFirestore(app);

    document.getElementById("org-select").addEventListener("change", (e) => {
        const isNew = e.target.value === "";
        document.getElementById("new-org-fields").style.display = isNew ? "block" : "none";
    });

    document.getElementById("log-form").addEventListener("submit", async (e) => {
        e.preventDefault();

        const user = auth.currentUser;
        if (!user) {
            alert("Please log in first.");
            return;
        }

        const orgSelect = document.getElementById("org-select");
        const selectedOrg = orgSelect.value;
        let orgId;

        if (selectedOrg) {
            orgId = selectedOrg; // Existing organization
        } else {
            const orgName = document.getElementById("org-name").value;
            const orgAddress = document.getElementById("org-address").value;
            const contact = {
                firstName: document.getElementById("contact-first").value,
                lastName: document.getElementById("contact-last").value,
                title: document.getElementById("contact-title").value,
                email: document.getElementById("contact-email").value,
                phone: document.getElementById("contact-phone").value
            };

            const orgRef = collection(db, "organizations");
            const newOrg = await addDoc(orgRef, {
                name: orgName,
                address: orgAddress,
                contact
            });
            orgId = newOrg.id;
        }

        await addDoc(collection(db, "users", user.uid, "hours"), {
            date: document.getElementById("log-date").value,
            hours: parseFloat(document.getElementById("log-hours").value),
            organizationId: orgId,
            notes: "",
            timestamp: new Date()
        });

        alert("Service hours logged!");
        document.getElementById("log-form").reset();
    });


</script>
</body>
